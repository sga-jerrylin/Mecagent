# 智能装配手册生成系统 - Agent架构文档 V2.0

## 系统概述

本系统采用多智能体协作架构，将复杂的装配手册生成任务分解为6个专业化的智能体。

**核心改进（V2.0）**：
- ✅ 统一使用 **Gemini 2.5 Flash** 多模态模型（视觉+文本）
- ✅ 扁平化编号体系（Agent 1-6，无子编号）
- ✅ 每个Agent都有酷炫的中文名称
- ✅ 明确定义每个Agent的输入（图片+文本）
- ✅ 区分组件级和产品级装配（支持不同的3D爆炸图）

---

## Agent编号体系

### **Agent 1: 视觉规划智能体**
- **编号**: Agent 1
- **中文名称**: 视觉规划智能体
- **英文名称**: Vision Planning Agent
- **模型**: Gemini 2.5 Flash (Google)
- **提示词文件**: `prompts/agent_1_vision_planning_prompts.py`
- **核心功能**:
  - 分析所有工程图纸（产品总图 + 组件图）
  - 识别产品层级结构（产品 → 组件 → 零件）
  - 规划组件预装配顺序（哪个组件先做）
  - 规划产品总装配顺序（组件之间如何装配）
  - 选择基准件/基准组件
- **输入**:
  - 📷 **图片**: 所有PDF图片（产品总图 + 组件图1/2/3/...）
  - 📄 **文本**: BOM表数据
- **输出**:
  - `component_assembly_plan`（组件装配规划）
  - `product_assembly_plan`（产品装配规划）
- **实现文件**: `agents/vision_planning_agent.py`

---

### **Agent 2: BOM-3D匹配智能体**
- **编号**: Agent 2
- **中文名称**: BOM-3D匹配智能体
- **英文名称**: BOM-3D Matching Agent
- **实现方式**: 代码匹配 + Gemini 2.5 Flash智能匹配
- **提示词文件**: `prompts/agent_2_bom_matcher_prompts.py`
- **核心功能**:
  - **代码匹配**（优先）:
    - 通过产品代号精确匹配
    - 通过规格匹配标准件
    - 编码修复（latin1→gbk）
  - **AI智能匹配**（补充）:
    - 处理代码匹配失败的零件
    - 通过推理和工程经验进行智能匹配
- **输入**:
  - 📷 **图片**: 无
  - 📄 **文本**: BOM表数据 + 3D零件列表
- **输出**:
  - `bom_to_mesh_mapping`（BOM到mesh_id的映射表）
  - `component_to_meshes_mapping`（组件到mesh_id集合的映射）
- **实现文件**:
  - `core/bom_3d_matcher.py`（代码匹配）
  - `agents/bom_matching_agent.py`（AI智能匹配）

---

### **Agent 3: 组件装配智能体**
- **编号**: Agent 3
- **中文名称**: 组件装配智能体
- **英文名称**: Component Assembly Agent
- **模型**: Gemini 2.5 Flash (Google)
- **提示词文件**: `prompts/agent_3_component_assembly_prompts.py`
- **核心功能**:
  - 为单个组件生成详细的装配步骤
  - 从基准件开始，逐步装配组件内的零件
  - 生成工人友好的操作说明
  - 包含质量检查点
- **可复用性**: ⭐ **可复用**，处理N个组件（N=1,2,3...10+）
- **输入**:
  - 📷 **图片**: 对应组件的图片（例如：组件1 → 组件图1）
  - 📄 **文本**:
    - Agent 1的组件装配规划
    - 组件内零件清单
    - BOM-3D映射表
- **输出**:
  - `component_assembly_steps`（组件装配步骤）
  - 每个步骤包含：
    - 零件列表
    - 3D高亮参数（零件级爆炸）
    - 操作说明
    - 质量检查点
- **3D显示特点**: 零件级爆炸图（只显示当前组件内的零件）
- **实现文件**: `agents/component_assembly_agent.py`

---

### **Agent 4: 产品总装智能体**
- **编号**: Agent 4
- **中文名称**: 产品总装智能体
- **英文名称**: Product Assembly Agent
- **模型**: Gemini 2.5 Flash (Google)
- **提示词文件**: `prompts/agent_4_product_assembly_prompts.py`
- **核心功能**:
  - 生成产品总装配步骤（组件之间如何装配）
  - 从基准组件开始，逐步装配其他组件
  - 生成工人友好的操作说明
  - 包含紧固件规格、拧紧力矩等
- **输入**:
  - 📷 **图片**: 产品总图
  - 📄 **文本**:
    - Agent 1的产品装配规划
    - 组件清单（已预装配完成）
    - BOM-3D映射表
- **输出**:
  - `product_assembly_steps`（产品总装步骤）
  - 每个步骤包含：
    - 组件信息
    - 紧固件列表
    - 3D高亮参数（组件级爆炸）
    - 操作说明
    - 质量检查点
- **3D显示特点**: 组件级爆炸图（显示组件整体，不显示组件内部零件）
- **实现文件**: `agents/product_assembly_agent.py`

---

### **Agent 5: 焊接工艺智能体**
- **编号**: Agent 5
- **中文名称**: 焊接工艺智能体
- **英文名称**: Welding Process Agent
- **模型**: Gemini 2.5 Flash (Google)
- **提示词文件**: `prompts/agent_5_welding_prompts.py`
- **核心功能**:
  - 从图纸中识别焊接符号
  - 将焊接符号翻译为工人友好的语言
  - 生成焊接要求清单
  - 包含焊接位置、焊接方法、质量要求
- **输入**:
  - 📷 **图片**: 所有PDF图片（产品总图 + 组件图）
  - 📄 **文本**:
    - Agent 3的组件装配步骤
    - Agent 4的产品总装步骤
- **输出**:
  - `welding_requirements`（焊接要求列表）
- **实现文件**: `agents/welding_agent.py`

---

### **Agent 6: 安全FAQ智能体**
- **编号**: Agent 6
- **中文名称**: 安全FAQ智能体
- **英文名称**: Safety FAQ Agent
- **模型**: Gemini 2.5 Flash (Google)
- **提示词文件**: `prompts/agent_6_safety_faq_prompts.py`
- **核心功能**:
  - 生成安全警告和注意事项
  - 生成常见问题FAQ
  - 提供故障排除建议
- **输入**:
  - 📷 **图片**: 无
  - 📄 **文本**:
    - Agent 3的组件装配步骤
    - Agent 4的产品总装步骤
    - Agent 5的焊接要求
- **输出**:
  - `safety_warnings`（安全警告列表）
  - `faq_items`（FAQ列表）
- **实现文件**: `agents/safety_faq_agent.py`

---

## 数据流架构（V2.0）

```
┌─────────────────────────────────────────────────────────────┐
│ 输入：PDF工程图纸 + STEP 3D模型                              │
│ - 产品总图.pdf                                               │
│ - 组件图1.pdf, 组件图2.pdf, 组件图3.pdf, ...                │
│ - 产品总图.step                                              │
│ - 组件图1.step, 组件图2.step, 组件图3.step, ...             │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤0：文件预处理                                            │
│ - PDF → 图片（按文件名分类）                                 │
│ - STEP → GLB（3D模型转换）                                   │
│ - BOM提取（文本通道）                                        │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Agent 1: 视觉规划智能体 (Gemini 2.5 Flash)                   │
│ 输入: 所有PDF图片 + BOM数据                                  │
│ 输出: 组件装配规划 + 产品装配规划                            │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Agent 2: BOM-3D匹配智能体 (代码 + Gemini)                    │
│ 输入: BOM数据 + 3D零件列表                                   │
│ 输出: BOM到mesh_id映射 + 组件到mesh集合映射                  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Agent 3: 组件装配智能体 (Gemini 2.5 Flash) ⭐ 可复用         │
│ 并行处理N个组件：                                            │
│ ├─ 组件1装配步骤（输入：组件图1 + 组件1规划）                │
│ ├─ 组件2装配步骤（输入：组件图2 + 组件2规划）                │
│ ├─ 组件3装配步骤（输入：组件图3 + 组件3规划）                │
│ └─ ...                                                       │
│ 输出: 所有组件的装配步骤（零件级3D爆炸）                     │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Agent 4: 产品总装智能体 (Gemini 2.5 Flash)                   │
│ 输入: 产品总图 + 产品装配规划 + 组件清单                     │
│ 输出: 产品总装步骤（组件级3D爆炸）                           │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Agent 5: 焊接工艺智能体 (Gemini 2.5 Flash)                   │
│ 输入: 所有PDF图片 + 装配步骤                                 │
│ 输出: 焊接要求清单                                           │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Agent 6: 安全FAQ智能体 (Gemini 2.5 Flash)                    │
│ 输入: 装配步骤 + 焊接要求                                    │
│ 输出: 安全警告 + FAQ                                         │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 数据集成模块                                                 │
│ 输出: final_manual.json                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 前端展示（Vue.js + Three.js）                                │
│ - 组件装配：零件级3D爆炸图                                   │
│ - 产品总装：组件级3D爆炸图                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## Agent输入输出汇总表

| Agent | 图片输入 | 文本输入 | 输出 | 3D显示特点 |
|-------|---------|---------|------|-----------|
| Agent 1 | 所有PDF图片 | BOM数据 | 装配规划 | - |
| Agent 2 | 无 | BOM + 3D零件列表 | BOM-3D映射 | - |
| Agent 3 | 对应组件图 | 组件规划 + 零件清单 | 组件装配步骤 | 零件级爆炸 |
| Agent 4 | 产品总图 | 产品规划 + 组件清单 | 产品总装步骤 | 组件级爆炸 |
| Agent 5 | 所有PDF图片 | 装配步骤 | 焊接要求 | - |
| Agent 6 | 无 | 装配步骤 + 焊接要求 | 安全FAQ | - |

---

## 提示词文件命名规范

所有提示词文件统一存放在 `prompts/` 目录下，命名规范：

```
agent_{编号}_{功能名称}_prompts.py
```

**V2.0示例**:
- `agent_1_vision_planning_prompts.py` - Agent 1视觉规划智能体
- `agent_2_bom_matcher_prompts.py` - Agent 2 BOM-3D匹配智能体
- `agent_3_component_assembly_prompts.py` - Agent 3组件装配智能体
- `agent_4_product_assembly_prompts.py` - Agent 4产品总装智能体
- `agent_5_welding_prompts.py` - Agent 5焊接工艺智能体
- `agent_6_safety_faq_prompts.py` - Agent 6安全FAQ智能体

---

## Agent实现文件命名规范

所有Agent实现文件统一存放在 `agents/` 目录下，命名规范：

```
{功能名称}_agent.py
```

**V2.0示例**:
- `agents/vision_planning_agent.py` - Agent 1
- `agents/bom_matching_agent.py` - Agent 2
- `agents/component_assembly_agent.py` - Agent 3
- `agents/product_assembly_agent.py` - Agent 4
- `agents/welding_agent.py` - Agent 5
- `agents/safety_faq_agent.py` - Agent 6
- `agents/base_gemini_agent.py` - Gemini基类（所有Agent继承）

---

## 当前实现状态（V2.0）

| Agent | 状态 | 模型 | 可复用 | 备注 |
|-------|------|------|--------|------|
| Agent 1 | ⏳ 开发中 | Gemini 2.5 Flash | ❌ | 视觉规划智能体 |
| Agent 2 | ⏳ 改造中 | 代码 + Gemini | ❌ | BOM-3D匹配智能体 |
| Agent 3 | ⏳ 开发中 | Gemini 2.5 Flash | ✅ | 组件装配智能体 |
| Agent 4 | ⏳ 开发中 | Gemini 2.5 Flash | ❌ | 产品总装智能体 |
| Agent 5 | ⏳ 开发中 | Gemini 2.5 Flash | ❌ | 焊接工艺智能体 |
| Agent 6 | ⏳ 开发中 | Gemini 2.5 Flash | ❌ | 安全FAQ智能体 |
| 集成模块 | ⏳ 改造中 | - | - | 数据集成 |

---

## 技术栈（V2.0）

- **AI模型**:
  - Gemini 2.5 Flash (Google) - 统一的多模态模型
- **后端**: Python, FastAPI
- **前端**: Vue.js 3, TypeScript, Three.js, GSAP
- **3D处理**: trimesh (STEP → GLB)
- **PDF处理**: PyMuPDF, pdf2image

---

## 核心改进点（V2.0）

1. **统一模型**：所有Agent使用Gemini 2.5 Flash，简化维护
2. **扁平化编号**：Agent 1-6，无子编号，清晰明了
3. **图片管理**：按文件名分类PDF图片，精确控制每个Agent的输入
4. **3D显示分离**：
   - 组件装配：零件级爆炸图
   - 产品总装：组件级爆炸图
5. **可复用设计**：Agent 3可处理任意数量的组件
6. **生产级代码**：核心逻辑在`agents/`和`core/`，测试脚本仅用于验证

